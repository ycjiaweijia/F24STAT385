---
title: "Introduction to Tidyverse and Tibbles"
output:
 slidy_presentation: default
 beamer_presentation:
  toc: yes
  theme: Boadilla
  colortheme: default
  number_sections: yes
 ioslides_presentation: default
fontsize: 10pt
editor_options:
 chunk_output_type: console
urlcolor: blue
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 4, fig.height = 6)
```



## Introduction to Tidyverse

* Tidyverse is **an collection of R packages** designed for data science, including **ggplot2**, **tibble**, **dplyr**, **tidyr**, **readr**, **stringr**, etc. 

* ggplot2 $\rightarrow$ for data visualization

* dplyr, tidyr $\rightarrow$ for data wrangling and data preparation


> ![Workflow in data science, with Tidyverse -- https://oliviergimenez.github.io/intro_tidyverse/#1](tidyverse_data_science.png){width=60%}

* Data preparation can take up to $70\%$–$80\%$ of your project time.
  - So wouldn't it be nice if there were an intuitive and idiomatic way to wrangle data?
  
## Install and Load Tidyverse

Please install and load the `tidyverse`.

```{r, eval=FALSE}

install.packages("tidyverse") # Remember, you ONLY need to install it once

library(tidyverse) # but you'll need to load it every session you use it
```



::: {style="height:30px;"}
:::

Once you're done, let's start the journey!

## Syntax Comparison: Base R vs Tidyverse

Let's use the *mpg* tibble in ggplot2. Please refer to `help(mpg)` for the variable definitions.

```{r}
library(tidyverse) 

str(mpg)
glimpse(mpg) # glimpse() is the counterpart in dplyr of str()
```

`r kableExtra::text_spec("Example 1", color = "#1696d2")` What types of vehicles did **dodge** produce from the *mpg* data?

## Syntax Comparison: Base R vs Tidyverse

`r kableExtra::text_spec("Example 1", color = "#1696d2")` What types of vehicles did **dodge** produce from the *mpg* data?

### Base R syntax

```{r}
unique(mpg[mpg$manufacturer == "dodge", "class"])
```

Fine, but a little awkward.

### Tidyverse syntax

```{r}
mpg %>%
 filter(manufacturer == "dodge") %>%
 distinct(class) 
```

Much, much nicer.


<!-- ```{r} -->
<!-- # Or equivalently,  -->
<!-- # mpg %>% -->
<!-- #  filter(manufacturer == "dodge") %>%  -->
<!-- #   select(class) %>%  -->
<!-- #   unique() -->
<!-- ``` -->


## Tidyverse Syntax and Pipe Operator


The **pipe operator**  `%>%` is used to build the pipeline.  

- You could interpret `%>%` as *then* 

- Passes result on left into first argument of function on right. 

![](figs and datasets/Pipe Operator.jpg){width=35%}

- Shortcut to type `%>%`

![](figs and datasets/Pipe Operator shortcut.jpg){width=15%}


- ` %>% ` has to come at the end of the line, not the start. 


## Check Missing Values

```{r}
mpg %>% 
  dplyr::select(everything()) %>% # use everything() to select all variables
  summarize_all(~sum(is.na(.))) # summarize_all() affects every variable
```

<!-- ## Exercise 1 -->


## Wrangling & Graphing in Tidyverse

Chain the tidyverse pipeline into the `ggplot` function. 

<!-- ```{r} -->
<!-- summary(mpg) -->
<!-- ``` -->

`r kableExtra::text_spec("Example 2", color = "#1696d2")`

Draw boxplots of engine displacement (variable **displ** in *mpg*) for three vehicle types of **dodge**. 


```{r}
mpg %>% ### Data wrangling part
 filter(manufacturer == "dodge") %>%
 ggplot(aes(x = class, y = displ)) + ### Data visualization part
 geom_boxplot() 
```

### Or equivalently,

```{r}
### Data wrangling part 
mpg_dodge <- mpg %>% 
  filter(manufacturer == "dodge")

### Data visualization part 
  ggplot(mpg_dodge, aes(x = class, y = displ)) + 
  geom_boxplot() 
```

<!-- ## Exercise 2 -->


## Tibbles

`tidyverse` mainly deals with `tibble` instead of `data.frame`. Therefore this is where we start.

`tibble` is a `data.frame` with different attributes and requirements. The package `tibble` provides support for `tibble`. It is included in `tidyverse`. 

<!-- All the following information is from `vignette("tibble")`. Refer to it for more details. -->


## Tibble vs Data Frame

* Tibbles are enhanced data frames.
* Tibbles are a table format provided by the **tibble** package, part of the core tidyverse. 
* Make working in the tidyverse a little easier.
* We will compare tibble and data frame on the following aspects:
  + Creating
  + Coercion (i.e. data frame $\longleftrightarrow$ tibble)
  + Difference in printing
  + Difference in subsetting
  + Difference in recycling rules
  + Difference in accepting row names


## Tibble vs Data Frame -- Creating (Import a CSV File)


#### Import Data as a Data frame

Recall: use `read.csv()` to read the data frame.

```{r}
df_workshop <- read.csv("DS Workshop Participants List.csv")
class(df_workshop)
str(df_workshop)
```

#### Import Data as a Tibble

* Use `read_csv()` (from `readr` package) to read the tibble. 

```{r}
tbl_workshop <- read_csv("DS Workshop Participants List.csv")
class(tbl_workshop)
glimpse(tbl_workshop) 
```


## Tibble vs Data Frame -- Creating (Construct a Data Frame by Columns)



### Data frame

```{r, error = TRUE}

data.frame('crazy name' = 1:3, 'not so crazy & name' = c("a", "b", "c"))

data.frame(x = 1:3, y = x + 2)
```




### Tibble

```{r}

tibble('crazy name' = 1:3, 'not so crazy & name' = c("a", "b", "c")) 
# Tibble allows  non-syntactic variable names. To refer to these variables, please surround them with backticks.

tibble(x = 1:3, y = x + 2) # Tibble allows referring to variables just created
```



## Tibble vs Data Frame -- Coercion

### Data Frame to Tibble

```{r}
class(df_workshop)

class(as_tibble(df_workshop))
```

### Tibble to Data Frame

```{r}
class(tbl_workshop) 

class(as.data.frame(tbl_workshop))
```


<!-- ### Construct a tibble by rows -- `tribble()` -->


<!-- ```{r} -->
<!-- titanic <- tribble( -->
<!--   ~Class, ~Sex, ~n, -->
<!--   "1st class", "female passengers", 144, -->
<!--   "1st class", "male passengers", 179, -->
<!--   "2nd class", "female passengers", 106, -->
<!--   "2nd class", "male passengers", 171,  -->
<!--   "3rd class", "female passengers", 216, -->
<!--   "3rd class", "male passengers", 493 -->
<!-- )  -->

<!-- titanic -->

<!-- titanic %>% filter(Sex == "female passengers") %>% -->
<!--   mutate(Class = factor(Class, levels = c("3rd class", "2nd class", "1st class"))) %>% ### fix the class levels, instead of using alphabetical order; -->
<!--   ggplot()+ -->
<!--   geom_col(mapping = aes(x=n, y=Class)) -->
<!-- ``` -->

## Tibble vs Data Frame -- printing


### Data Frame

```{r}
df_workshop
```

### Tibble

```{r}
tbl_workshop
```

## Tibble vs Data Frame -- Subsetting

### Recall Subsetting in Data Frame


```{r}
df_workshop$Major # Returns a vector
df_workshop[, "Major"] # Returns a vector
```



### Subsetting in tibble -- distinguish [] and [[]] in tibble


* Using [] returns a tibble
```{r}
tbl_workshop[,'Major'] 
tbl_workshop['Major']
```

* Using [[]] or drop = TRUE returns a vector

```{r}
tbl_workshop[['Major']]
tbl_workshop[,'Major', drop = TRUE]
```

## Tibble vs Data Frame -- Recycling 

### Data frames -- recycling rule is applied automatically

```{r}
data.frame(x = 1:6, y = "STAT")

data.frame(x = 1:6, y = "STAT", z = c("Y", "N"))
```


### Tibble -- only values of length 1 are recycled


```{r, error = TRUE}
tibble(x = 1:6, y = "STAT")

tibble(x = 1:6, y = "STAT", z = c("Y", "N"))

# Correction
tibble(x = 1:6, y = "STAT", z = rep(c("Y", "N"), times = 3))
```



## Tibble vs Data Frame -- Row Names


### Data frames accept assigned row names

```{r}
rownames(df_workshop) <- letters[1:16]
head(df_workshop)
```

### Tibbles don't accept assigned row names


```{r, error = TRUE}
rownames(tbl_workshop) <- letters[1:16]

```

<!-- ### Convert a named vector to a tibble -->

<!-- ```{r} -->
<!-- x <- c(1,2,3) -->
<!-- class(x) -->

<!-- tbl_x = enframe(x) -->
<!-- class(tbl_x) -->
<!-- ``` -->





<!-- ### Data Frame or Tibble? -->

<!-- Would like to know more? Use `vignette("tibble")` to find more info.  -->

<!-- * In the class, we use the terms *tibble* and *data frame* interchangeably. -->


<!-- # Exercise 3 and 4 -->



<!-- ## Tidy data -->

<!-- > Happy families are all alike; every unhappy family is unhappy in its own way. — Leo Tolstoy -->

<!-- > Tidy datasets are all alike, but every messy dataset is messy in its own way. — Hadley Wickham, author of *R for Data Science* -->

<!-- ## Tidy data -->

<!-- > Happy families are all alike; every unhappy family is unhappy in its own way. — Leo Tolstoy -->

<!-- > Tidy datasets are all alike, but every messy dataset is messy in its own way. — Hadley Wickham, author of *R for Data Science* -->

<!-- ### Three interrelated rules which make a dataset tidy -->

<!-- 1. Each variable must have its own column. -->

<!-- 2. Each observation must have its own row. -->

<!-- 3. Each value must have its own cell. -->

<!-- ![](figs and datasets/tidydata.jpg){width=50%} -->

<!-- ## Tidy data -->

<!-- > Happy families are all alike; every unhappy family is unhappy in its own way. — Leo Tolstoy -->

<!-- > Tidy datasets are all alike, but every messy dataset is messy in its own way. — Hadley Wickham, author of *R for Data Science* -->

<!-- ### Three interrelated rules which make a dataset tidy -->

<!-- 1. Each variable must have its own column. -->

<!-- 2. Each observation must have its own row. -->

<!-- 3. Each value must have its own cell. -->

<!-- ![](figs and datasets/tidydata.jpg){width=50%} -->

<!-- ```{r} -->
<!-- table1 -->
<!-- table2 -->
<!-- table3 -->
<!-- table4a -->
<!-- table4b -->
<!-- ``` -->

<!-- Which table is tidy? Table 1? Table 2? Table 3? Or Table 4? -->

<!-- - Please response to the poll question on Webex. -->


<!-- ## Tidy the tables -->

<!-- To tidy the data, we will need to `gather()/spread()/seperate()` as shown below.  -->

<!-- #### Spreading table2 makes it tidy -->

<!-- ![](figs and datasets/Spreading table2 makes it tidy.jpg){width=50%} -->

<!-- #### Separating table3 makes it tidy -->

<!-- ![](figs and datasets/Separating table3 makes it tidy.jpg){width=50%} -->

<!-- #### Gathering table4 into a tidy form -->
<!-- ![](figs and datasets/Gathering table4 into a tidy form.jpg){width=50%} -->

<!-- ### Code to tidy the tables -->

<!-- #### Tidy table 2 using spread() -->

<!-- ```{r} -->
<!-- spread(table2, key = 'type', value = 'count') -->
<!-- ``` -->

<!-- #### Tidy table3 using separate() -->

<!-- ```{r} -->
<!-- table3 %>% -->
<!--  separate(rate, into = c("cases", "population"), sep = "/") -->
<!-- ``` -->

<!-- #### Tidy table 4 using gather() and left_join() -->

<!-- ```{r} -->
<!-- tidy4a <- table4a %>% -->
<!-- gather(`1999`, `2000`, key = "year", value = "cases") -->

<!-- tidy4b <- table4b %>% -->
<!-- gather(`1999`, `2000`, key = "year", value = "population") -->

<!-- left_join(tidy4a, tidy4b) -->
<!-- ``` -->




## More motivation

- The tidyverse has become the industry-standard in the R-using data science community.

- The tidyverse in R is comparable to the `numpy` and `pandas` packages in Python.



## Reference

#### Reference books
* R for Data Science: https://r4ds.hadley.nz/ 
* Hands-on Programming with R: https://rstudio-education.github.io/hopr/
* R Graphics Cookbook: https://r-graphics.org/
* Statistical Inference via Data Science: A Modern Dive into R and the Tidyverse, by Chester Ismay, Albert Y. Kim
* `vignette("tibble")` or <https://tibble.tidyverse.org/articles/tibble.html#tibbles-vs-data-frames> 
* And some github resources:
<https://github.com/stmorse/intro-tidyverse>

<https://github.com/rstudio-education/welcome-to-the-tidyverse>


